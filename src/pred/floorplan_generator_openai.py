import os
import json
from tqdm import tqdm
from dotenv import load_dotenv
from src.utils import create_input
from src.pred.feedback_generator import FeedbackGenerator
from src.pred.extract_output_json import extract_output_json
from datasets import load_from_disk
from vllm import LLM, SamplingParams
from vllm.lora.request import LoRARequest
from openai import OpenAI

load_dotenv()
CACHE_DIR = os.environ.get("TRANSFORMERS_CACHE")
    
class FloorplanGenerator:
    def __init__(
        self,
        model_name_or_path="meta-llama/Llama-3.3-70B-Instruct",
        lora_adapter_path=None,
        dataset_name_or_path="datasets/rplan_converted",
        test_split="test",
        test_range=None,
        max_new_tokens=4096,
        batch_size=32,
        device="cuda",
        output_dir="outputs"
    ):
        self.model_name_or_path = model_name_or_path
        self.lora_adapter_path = lora_adapter_path
        self.dataset_name_or_path = dataset_name_or_path
        self.test_split = test_split
        self.max_new_tokens = max_new_tokens
        self.batch_size = batch_size
        self.device = device
        self.output_dir = output_dir
        self.test_range_start = 0

        if self.model_name_or_path == "gpt-4o":
            self.client = OpenAI()
        else:
            self.model = LLM(
                model=self.model_name_or_path,
                tensor_parallel_size=4,
                device=self.device,
                enable_lora=True
            )
            self.lora_request = LoRARequest("floorplan_adapter", 1, self.lora_adapter_path)
            self.sampling_params = SamplingParams(
                max_tokens=self.max_new_tokens
            )

        self.dataset = load_from_disk(self.dataset_name_or_path)[self.test_split]
        if test_range:
            try:
                self.test_range_start, self.test_range_end = map(int, test_range.split(","))
                self.test_range_start = self.test_range_start - 1
                self.dataset = self.dataset.select(range(self.test_range_start, self.test_range_end))
            except Exception as e:
                print("Invalid test_range format. Expected format: 'start,end' (e.g., '1,101').")
        self.total_examples = len(self.dataset)
        os.makedirs(self.output_dir, exist_ok=True)

    def _build_prompt(self, sample):
        system_prompt = (
            "you are to generate a floor plan in a JSON structure. "
            "you also need to satisfy additional constraints given by the user."
        )
        user_prompt = create_input(sample, is_str=True)
        messages = [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_prompt},
        ]
        return messages

    def _build_re_prompt(self, sample, history=None):
        system_prompt = (
            f"you are to generate a floor plan in a JSON structure. "
            "you also need to satisfy additional constraints given by the user. Only return the JSON in a 'output' key. Follow the same JSON schema as the examples:"
        )

        messages = [
            {"role": "system", "content": system_prompt},
            {
                "role": "user", 
                "content": """
                    1. {'input': {'room_count': 12, 'total_area': 60.8, 'room_types': ['balcony', 'bedroom', 'bedroom', 'kitchen', 'bathroom', 'living_room', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'front_door'], 'rooms': [{'room_type': 'balcony', 'width': 1.0, 'height': 3.5, 'is_regular': 1}, {'room_type': 'bedroom', 'width': 3.2, 'height': 4.4, 'is_regular': 1}, {'room_type': 'bedroom', 'width': 3.2, 'height': 2.5, 'is_regular': 1}, {'room_type': 'kitchen', 'width': 2.1, 'height': 2.5, 'is_regular': 0}, {'room_type': 'bathroom', 'width': 1.8, 'height': 1.5, 'is_regular': 1}, {'room_type': 'living_room', 'width': 6.8, 'height': 4.7, 'is_regular': 0}, {'room_type': 'interior_door', 'width': 0.8, 'height': 0.3, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 0.3, 'height': 2.4, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 0.3, 'height': 0.6, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 0.8, 'height': 0.3, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 0.8, 'height': 0.1, 'is_regular': 1}, {'room_type': 'front_door', 'width': 0.3, 'height': 0.8, 'is_regular': 1}]}}
                       {'output': {'room_count': 12, 'total_area': 60.8, 'room_types': ['balcony', 'bedroom', 'bedroom', 'kitchen', 'bathroom', 'living_room', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'front_door'], 'rooms': [{'area': 3.5, 'floor_polygon': [{'x': 12.6, 'y': 6.3}, {'x': 12.6, 'y': 9.8}, {'x': 13.6, 'y': 9.8}, {'x': 13.6, 'y': 6.3}], 'height': 3.5, 'id': 0, 'is_regular': 1, 'room_type': 'balcony', 'width': 1.0}, {'area': 13.8, 'floor_polygon': [{'x': 12.2, 'y': 14.6}, {'x': 12.2, 'y': 10.3}, {'x': 9.0, 'y': 10.3}, {'x': 9.0, 'y': 14.6}], 'height': 4.4, 'id': 1, 'is_regular': 1, 'room_type': 'bedroom', 'width': 3.2}, {'area': 8.0, 'floor_polygon': [{'x': 12.2, 'y': 3.4}, {'x': 9.0, 'y': 3.4}, {'x': 9.0, 'y': 5.9}, {'x': 12.2, 'y': 5.9}], 'height': 2.5, 'id': 2, 'is_regular': 1, 'room_type': 'bedroom', 'width': 3.2}, {'area': 5.3, 'floor_polygon': [{'x': 4.4, 'y': 5.9}, {'x': 6.5, 'y': 5.9}, {'x': 6.5, 'y': 4.9}, {'x': 6.5, 'y': 4.9}, {'x': 6.5, 'y': 3.4}, {'x': 4.4, 'y': 3.4}], 'height': 2.5, 'id': 3, 'is_regular': 0, 'room_type': 'kitchen', 'width': 2.1}, {'area': 2.6, 'floor_polygon': [{'x': 8.6, 'y': 3.4}, {'x': 6.8, 'y': 3.4}, {'x': 6.8, 'y': 4.9}, {'x': 8.6, 'y': 4.9}], 'height': 1.5, 'id': 4, 'is_regular': 1, 'room_type': 'bathroom', 'width': 1.8}, {'area': 26.0, 'floor_polygon': [{'x': 6.9, 'y': 6.3}, {'x': 5.3, 'y': 6.3}, {'x': 5.3, 'y': 9.8}, {'x': 12.2, 'y': 9.8}, {'x': 12.2, 'y': 6.3}, {'x': 8.6, 'y': 6.3}, {'x': 8.6, 'y': 5.1}, {'x': 6.9, 'y': 5.1}], 'height': 4.7, 'id': 5, 'is_regular': 0, 'room_type': 'living_room', 'width': 6.8}, {'area': 0.2, 'floor_polygon': [{'x': 9.0, 'y': 10.2}, {'x': 9.8, 'y': 10.2}, {'x': 9.8, 'y': 9.9}, {'x': 9.0, 'y': 9.9}], 'height': 0.3, 'id': 6, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.8}, {'area': 0.7, 'floor_polygon': [{'x': 12.5, 'y': 9.3}, {'x': 12.5, 'y': 6.9}, {'x': 12.2, 'y': 6.9}, {'x': 12.2, 'y': 9.3}], 'height': 2.4, 'id': 7, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.3}, {'area': 0.2, 'floor_polygon': [{'x': 8.9, 'y': 5.9}, {'x': 8.9, 'y': 5.3}, {'x': 8.6, 'y': 5.3}, {'x': 8.6, 'y': 5.9}], 'height': 0.6, 'id': 8, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.3}, {'area': 0.2, 'floor_polygon': [{'x': 5.7, 'y': 6.0}, {'x': 5.7, 'y': 6.3}, {'x': 6.5, 'y': 6.3}, {'x': 6.5, 'y': 6.0}], 'height': 0.3, 'id': 9, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.8}, {'area': 0.1, 'floor_polygon': [{'x': 8.6, 'y': 4.9}, {'x': 7.7, 'y': 4.9}, {'x': 7.7, 'y': 5.1}, {'x': 8.6, 'y': 5.1}], 'height': 0.1, 'id': 10, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.8}, {'area': 0.2, 'floor_polygon': [{'x': 5.3, 'y': 8.2}, {'x': 5.0, 'y': 8.2}, {'x': 5.0, 'y': 9.1}, {'x': 5.3, 'y': 9.1}], 'height': 0.8, 'id': 11, 'is_regular': 1, 'room_type': 'front_door', 'width': 0.3}]}}
                """
            },
            {
                "role": "user", 
                "content": """
                   2. {'input': {'room_count': 16, 'total_area': 73.9, 'room_types': ['study_room', 'bathroom', 'living_room', 'bedroom', 'bedroom', 'balcony', 'kitchen', 'balcony', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'front_door'], 'rooms': [{'room_type': 'study_room', 'width': 2.4, 'height': 2.7, 'is_regular': 1}, {'room_type': 'bathroom', 'width': 1.3, 'height': 1.8, 'is_regular': 1}, {'room_type': 'living_room', 'width': 6.8, 'height': 7.9, 'is_regular': 0}, {'room_type': 'bedroom', 'width': 3.3, 'height': 4.0, 'is_regular': 1}, {'room_type': 'bedroom', 'width': 2.7, 'height': 2.7, 'is_regular': 1}, {'room_type': 'balcony', 'width': 3.9, 'height': 1.2, 'is_regular': 1}, {'room_type': 'kitchen', 'width': 2.7, 'height': 2.1, 'is_regular': 1}, {'room_type': 'balcony', 'width': 0.9, 'height': 2.1, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 0.6, 'height': 0.1, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 0.7, 'height': 0.1, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 0.1, 'height': 0.6, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 0.7, 'height': 0.1, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 1.4, 'height': 0.1, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 1.4, 'height': 0.1, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 0.1, 'height': 1.3, 'is_regular': 1}, {'room_type': 'front_door', 'width': 0.8, 'height': 0.1, 'is_regular': 1}]}}
                    {'output': {'room_count': 16, 'total_area': 73.9, 'room_types': ['study_room', 'bathroom', 'living_room', 'bedroom', 'bedroom', 'balcony', 'kitchen', 'balcony', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'front_door'], 'rooms': [{'area': 6.6, 'floor_polygon': [{'x': 12.0, 'y': 5.0}, {'x': 9.6, 'y': 5.0}, {'x': 9.6, 'y': 7.7}, {'x': 12.0, 'y': 7.7}], 'height': 2.7, 'id': 0, 'is_regular': 1, 'room_type': 'study_room', 'width': 2.4}, {'area': 2.3, 'floor_polygon': [{'x': 7.9, 'y': 6.0}, {'x': 7.9, 'y': 7.7}, {'x': 9.3, 'y': 7.7}, {'x': 9.3, 'y': 6.0}], 'height': 1.8, 'id': 1, 'is_regular': 1, 'room_type': 'bathroom', 'width': 1.3}, {'area': 31.1, 'floor_polygon': [{'x': 3.8, 'y': 5.0}, {'x': 3.8, 'y': 12.9}, {'x': 7.7, 'y': 12.9}, {'x': 7.7, 'y': 9.0}, {'x': 10.6, 'y': 9.0}, {'x': 10.6, 'y': 8.0}, {'x': 7.7, 'y': 8.0}, {'x': 7.7, 'y': 6.0}, {'x': 5.1, 'y': 6.0}, {'x': 5.1, 'y': 5.0}], 'height': 7.9, 'id': 2, 'is_regular': 0, 'room_type': 'living_room', 'width': 6.8}, {'area': 13.2, 'floor_polygon': [{'x': 14.2, 'y': 12.0}, {'x': 14.2, 'y': 8.0}, {'x': 10.9, 'y': 8.0}, {'x': 10.9, 'y': 12.0}], 'height': 4.0, 'id': 3, 'is_regular': 1, 'room_type': 'bedroom', 'width': 3.3}, {'area': 7.3, 'floor_polygon': [{'x': 7.9, 'y': 12.0}, {'x': 10.6, 'y': 12.0}, {'x': 10.6, 'y': 9.3}, {'x': 7.9, 'y': 9.3}], 'height': 2.7, 'id': 4, 'is_regular': 1, 'room_type': 'bedroom', 'width': 2.7}, {'area': 4.6, 'floor_polygon': [{'x': 7.7, 'y': 14.4}, {'x': 7.7, 'y': 13.2}, {'x': 3.8, 'y': 13.2}, {'x': 3.8, 'y': 14.4}], 'height': 1.2, 'id': 5, 'is_regular': 1, 'room_type': 'balcony', 'width': 3.9}, {'area': 5.8, 'floor_polygon': [{'x': 8.1, 'y': 5.7}, {'x': 8.1, 'y': 3.6}, {'x': 5.3, 'y': 3.6}, {'x': 5.3, 'y': 5.7}], 'height': 2.1, 'id': 6, 'is_regular': 1, 'room_type': 'kitchen', 'width': 2.7}, {'area': 1.9, 'floor_polygon': [{'x': 8.4, 'y': 3.6}, {'x': 8.4, 'y': 5.7}, {'x': 9.3, 'y': 5.7}, {'x': 9.3, 'y': 3.6}], 'height': 2.1, 'id': 7, 'is_regular': 1, 'room_type': 'balcony', 'width': 0.9}, {'area': 0.1, 'floor_polygon': [{'x': 9.1, 'y': 7.9}, {'x': 9.1, 'y': 7.8}, {'x': 8.5, 'y': 7.8}, {'x': 8.5, 'y': 7.9}], 'height': 0.1, 'id': 8, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.6}, {'area': 0.1, 'floor_polygon': [{'x': 10.5, 'y': 7.9}, {'x': 10.5, 'y': 7.8}, {'x': 9.8, 'y': 7.8}, {'x': 9.8, 'y': 7.9}], 'height': 0.1, 'id': 9, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.7}, {'area': 0.1, 'floor_polygon': [{'x': 10.8, 'y': 8.2}, {'x': 10.7, 'y': 8.2}, {'x': 10.7, 'y': 8.9}, {'x': 10.8, 'y': 8.9}], 'height': 0.6, 'id': 10, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.1}, {'area': 0.1, 'floor_polygon': [{'x': 9.8, 'y': 9.1}, {'x': 9.8, 'y': 9.2}, {'x': 10.5, 'y': 9.2}, {'x': 10.5, 'y': 9.1}], 'height': 0.1, 'id': 11, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.7}, {'area': 0.2, 'floor_polygon': [{'x': 6.3, 'y': 13.0}, {'x': 4.9, 'y': 13.0}, {'x': 4.9, 'y': 13.1}, {'x': 6.3, 'y': 13.1}], 'height': 0.1, 'id': 12, 'is_regular': 1, 'room_type': 'interior_door', 'width': 1.4}, {'area': 0.2, 'floor_polygon': [{'x': 7.5, 'y': 5.9}, {'x': 7.5, 'y': 5.8}, {'x': 6.0, 'y': 5.8}, {'x': 6.0, 'y': 5.9}], 'height': 0.1, 'id': 13, 'is_regular': 1, 'room_type': 'interior_door', 'width': 1.4}, {'area': 0.2, 'floor_polygon': [{'x': 8.2, 'y': 4.3}, {'x': 8.2, 'y': 5.6}, {'x': 8.3, 'y': 5.6}, {'x': 8.3, 'y': 4.3}], 'height': 1.3, 'id': 14, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.1}, {'area': 0.1, 'floor_polygon': [{'x': 4.9, 'y': 4.8}, {'x': 4.0, 'y': 4.8}, {'x': 4.0, 'y': 4.9}, {'x': 4.9, 'y': 4.9}], 'height': 0.1, 'id': 15, 'is_regular': 1, 'room_type': 'front_door', 'width': 0.8}]}}
                """
            },
            {
                "role": "user", 
                "content": """
                    3. {'input': {'room_count': 17, 'total_area': 87.7, 'room_types': ['balcony', 'living_room', 'bedroom', 'bathroom', 'bathroom', 'bedroom', 'kitchen', 'bedroom', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'front_door'], 'rooms': [{'room_type': 'balcony', 'width': 6.9, 'height': 1.1, 'is_regular': 1}, {'room_type': 'living_room', 'width': 5.9, 'height': 9.1, 'is_regular': 0}, {'room_type': 'bedroom', 'width': 3.0, 'height': 4.6, 'is_regular': 0}, {'room_type': 'bathroom', 'width': 1.9, 'height': 2.0, 'is_regular': 1}, {'room_type': 'bathroom', 'width': 1.9, 'height': 1.4, 'is_regular': 1}, {'room_type': 'bedroom', 'width': 3.0, 'height': 3.2, 'is_regular': 1}, {'room_type': 'kitchen', 'width': 2.8, 'height': 1.4, 'is_regular': 1}, {'room_type': 'bedroom', 'width': 2.9, 'height': 4.1, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 2.1, 'height': 0.3, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 0.6, 'height': 0.1, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 1.8, 'height': 0.3, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 0.1, 'height': 0.8, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 0.1, 'height': 0.6, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 0.5, 'height': 0.1, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 1.8, 'height': 0.3, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 0.3, 'height': 1.0, 'is_regular': 1}, {'room_type': 'front_door', 'width': 0.3, 'height': 1.0, 'is_regular': 1}]}}
                    {'output': {'room_count': 17, 'total_area': 87.7, 'room_types': ['balcony', 'living_room', 'bedroom', 'bathroom', 'bathroom', 'bedroom', 'kitchen', 'bedroom', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'front_door'], 'rooms': [{'area': 7.3, 'floor_polygon': [{'x': 4.2, 'y': 3.9}, {'x': 11.1, 'y': 3.9}, {'x': 11.1, 'y': 2.8}, {'x': 4.2, 'y': 2.8}], 'height': 1.1, 'id': 0, 'is_regular': 1, 'room_type': 'balcony', 'width': 6.9}, {'area': 34.7, 'floor_polygon': [{'x': 6.4, 'y': 9.1}, {'x': 6.4, 'y': 9.8}, {'x': 6.5, 'y': 9.8}, {'x': 6.5, 'y': 10.3}, {'x': 6.4, 'y': 10.3}, {'x': 6.4, 'y': 11.7}, {'x': 7.7, 'y': 11.7}, {'x': 7.7, 'y': 13.4}, {'x': 10.5, 'y': 13.4}, {'x': 10.5, 'y': 10.7}, {'x': 12.3, 'y': 10.7}, {'x': 12.3, 'y': 9.1}, {'x': 11.1, 'y': 9.1}, {'x': 11.1, 'y': 4.3}, {'x': 7.7, 'y': 4.3}, {'x': 7.7, 'y': 9.1}], 'height': 9.1, 'id': 1, 'is_regular': 0, 'room_type': 'living_room', 'width': 5.9}, {'area': 10.9, 'floor_polygon': [{'x': 6.4, 'y': 7.5}, {'x': 6.4, 'y': 8.9}, {'x': 7.2, 'y': 8.9}, {'x': 7.2, 'y': 4.3}, {'x': 4.2, 'y': 4.3}, {'x': 4.2, 'y': 7.5}], 'height': 4.6, 'id': 2, 'is_regular': 0, 'room_type': 'bedroom', 'width': 3.0}, {'area': 3.9, 'floor_polygon': [{'x': 4.2, 'y': 9.8}, {'x': 6.1, 'y': 9.8}, {'x': 6.1, 'y': 7.8}, {'x': 4.2, 'y': 7.8}], 'height': 2.0, 'id': 3, 'is_regular': 1, 'room_type': 'bathroom', 'width': 1.9}, {'area': 2.7, 'floor_polygon': [{'x': 4.2, 'y': 10.3}, {'x': 4.2, 'y': 11.7}, {'x': 6.1, 'y': 11.7}, {'x': 6.1, 'y': 10.3}], 'height': 1.4, 'id': 4, 'is_regular': 1, 'room_type': 'bathroom', 'width': 1.9}, {'area': 9.8, 'floor_polygon': [{'x': 7.2, 'y': 15.2}, {'x': 7.2, 'y': 12.0}, {'x': 4.2, 'y': 12.0}, {'x': 4.2, 'y': 15.2}], 'height': 3.2, 'id': 5, 'is_regular': 1, 'room_type': 'bedroom', 'width': 3.0}, {'area': 4.0, 'floor_polygon': [{'x': 7.7, 'y': 15.2}, {'x': 10.5, 'y': 15.2}, {'x': 10.5, 'y': 13.8}, {'x': 7.7, 'y': 13.8}], 'height': 1.4, 'id': 6, 'is_regular': 1, 'room_type': 'kitchen', 'width': 2.8}, {'area': 11.8, 'floor_polygon': [{'x': 13.8, 'y': 15.2}, {'x': 13.8, 'y': 11.1}, {'x': 10.9, 'y': 11.1}, {'x': 10.9, 'y': 15.2}], 'height': 4.1, 'id': 7, 'is_regular': 1, 'room_type': 'bedroom', 'width': 2.9}, {'area': 0.6, 'floor_polygon': [{'x': 8.4, 'y': 3.9}, {'x': 8.4, 'y': 4.2}, {'x': 10.5, 'y': 4.2}, {'x': 10.5, 'y': 3.9}], 'height': 0.3, 'id': 8, 'is_regular': 1, 'room_type': 'interior_door', 'width': 2.1}, {'area': 0.1, 'floor_polygon': [{'x': 7.3, 'y': 9.1}, {'x': 7.3, 'y': 8.9}, {'x': 6.8, 'y': 8.9}, {'x': 6.8, 'y': 9.1}], 'height': 0.1, 'id': 9, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.6}, {'area': 0.5, 'floor_polygon': [{'x': 4.9, 'y': 3.9}, {'x': 4.9, 'y': 4.2}, {'x': 6.8, 'y': 4.2}, {'x': 6.8, 'y': 3.9}], 'height': 0.3, 'id': 10, 'is_regular': 1, 'room_type': 'interior_door', 'width': 1.8}, {'area': 0.1, 'floor_polygon': [{'x': 6.3, 'y': 7.7}, {'x': 6.2, 'y': 7.7}, {'x': 6.2, 'y': 8.6}, {'x': 6.3, 'y': 8.6}], 'height': 0.8, 'id': 11, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.1}, {'area': 0.1, 'floor_polygon': [{'x': 6.2, 'y': 10.5}, {'x': 6.2, 'y': 11.1}, {'x': 6.3, 'y': 11.1}, {'x': 6.3, 'y': 10.5}], 'height': 0.6, 'id': 12, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.1}, {'area': 0.1, 'floor_polygon': [{'x': 6.8, 'y': 11.9}, {'x': 7.2, 'y': 11.9}, {'x': 7.2, 'y': 11.7}, {'x': 6.8, 'y': 11.7}], 'height': 0.1, 'id': 13, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.5}, {'area': 0.5, 'floor_polygon': [{'x': 8.2, 'y': 13.4}, {'x': 8.2, 'y': 13.7}, {'x': 10.0, 'y': 13.7}, {'x': 10.0, 'y': 13.4}], 'height': 0.3, 'id': 14, 'is_regular': 1, 'room_type': 'interior_door', 'width': 1.8}, {'area': 0.3, 'floor_polygon': [{'x': 10.8, 'y': 12.0}, {'x': 10.8, 'y': 11.0}, {'x': 10.5, 'y': 11.0}, {'x': 10.5, 'y': 12.0}], 'height': 1.0, 'id': 15, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.3}, {'area': 0.3, 'floor_polygon': [{'x': 12.4, 'y': 10.5}, {'x': 12.7, 'y': 10.5}, {'x': 12.7, 'y': 9.5}, {'x': 12.4, 'y': 9.5}], 'height': 1.0, 'id': 16, 'is_regular': 1, 'room_type': 'front_door', 'width': 0.3}]}}
                """
            },
            {
                "role": "user", 
                "content": """
                    4. {'input': {'room_count': 15, 'total_area': 78.9, 'room_types': ['bedroom', 'bathroom', 'bathroom', 'kitchen', 'bedroom', 'balcony', 'bedroom', 'living_room', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'front_door'], 'rooms': [{'room_type': 'bedroom', 'width': 3.5, 'height': 2.7, 'is_regular': 1}, {'room_type': 'bathroom', 'width': 2.5, 'height': 1.8, 'is_regular': 1}, {'room_type': 'bathroom', 'width': 2.0, 'height': 1.8, 'is_regular': 1}, {'room_type': 'kitchen', 'width': 3.8, 'height': 1.5, 'is_regular': 1}, {'room_type': 'bedroom', 'width': 6.0, 'height': 2.8, 'is_regular': 0}, {'room_type': 'balcony', 'width': 0.6, 'height': 2.2, 'is_regular': 1}, {'room_type': 'bedroom', 'width': 3.8, 'height': 2.7, 'is_regular': 1}, {'room_type': 'living_room', 'width': 7.5, 'height': 6.0, 'is_regular': 0}, {'room_type': 'interior_door', 'width': 1.0, 'height': 0.1, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 0.1, 'height': 1.5, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 0.1, 'height': 0.8, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 0.7, 'height': 0.1, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 0.8, 'height': 0.1, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 1.0, 'height': 0.1, 'is_regular': 1}, {'room_type': 'front_door', 'width': 0.8, 'height': 0.1, 'is_regular': 1}]}}
                       {'output': {'room_count': 15, 'total_area': 78.9, 'room_types': ['bedroom', 'bathroom', 'bathroom', 'kitchen', 'bedroom', 'balcony', 'bedroom', 'living_room', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'front_door'], 'rooms': [{'area': 9.4, 'floor_polygon': [{'x': 8.6, 'y': 10.8}, {'x': 8.6, 'y': 8.1}, {'x': 5.1, 'y': 8.1}, {'x': 5.1, 'y': 10.8}], 'height': 2.7, 'id': 0, 'is_regular': 1, 'room_type': 'bedroom', 'width': 3.5}, {'area': 4.3, 'floor_polygon': [{'x': 7.5, 'y': 6.8}, {'x': 10.0, 'y': 6.8}, {'x': 10.0, 'y': 5.0}, {'x': 7.5, 'y': 5.0}], 'height': 1.8, 'id': 1, 'is_regular': 1, 'room_type': 'bathroom', 'width': 2.5}, {'area': 3.5, 'floor_polygon': [{'x': 10.3, 'y': 6.8}, {'x': 12.2, 'y': 6.8}, {'x': 12.2, 'y': 5.0}, {'x': 10.3, 'y': 5.0}], 'height': 1.8, 'id': 2, 'is_regular': 1, 'room_type': 'bathroom', 'width': 2.0}, {'area': 5.9, 'floor_polygon': [{'x': 10.3, 'y': 13.0}, {'x': 14.1, 'y': 13.0}, {'x': 14.1, 'y': 11.5}, {'x': 10.3, 'y': 11.5}], 'height': 1.5, 'id': 3, 'is_regular': 1, 'room_type': 'kitchen', 'width': 3.8}, {'area': 14.1, 'floor_polygon': [{'x': 2.6, 'y': 5.0}, {'x': 2.6, 'y': 7.8}, {'x': 8.6, 'y': 7.8}, {'x': 8.6, 'y': 7.0}, {'x': 7.2, 'y': 7.0}, {'x': 7.2, 'y': 5.0}], 'height': 2.8, 'id': 4, 'is_regular': 0, 'room_type': 'bedroom', 'width': 6.0}, {'area': 1.4, 'floor_polygon': [{'x': 2.3, 'y': 5.0}, {'x': 1.7, 'y': 5.0}, {'x': 1.7, 'y': 7.2}, {'x': 2.3, 'y': 7.2}], 'height': 2.2, 'id': 5, 'is_regular': 1, 'room_type': 'balcony', 'width': 0.6}, {'area': 10.1, 'floor_polygon': [{'x': 12.5, 'y': 7.7}, {'x': 16.3, 'y': 7.7}, {'x': 16.3, 'y': 5.0}, {'x': 12.5, 'y': 5.0}], 'height': 2.7, 'id': 6, 'is_regular': 1, 'room_type': 'bedroom', 'width': 3.8}, {'area': 29.4, 'floor_polygon': [{'x': 16.3, 'y': 11.2}, {'x': 16.3, 'y': 7.9}, {'x': 12.2, 'y': 7.9}, {'x': 12.2, 'y': 7.0}, {'x': 8.9, 'y': 7.0}, {'x': 8.9, 'y': 13.0}, {'x': 10.1, 'y': 13.0}, {'x': 10.1, 'y': 11.2}], 'height': 6.0, 'id': 7, 'is_regular': 0, 'room_type': 'living_room', 'width': 7.5}, {'area': 0.1, 'floor_polygon': [{'x': 7.4, 'y': 7.0}, {'x': 8.4, 'y': 7.0}, {'x': 8.4, 'y': 6.8}, {'x': 7.4, 'y': 6.8}], 'height': 0.1, 'id': 8, 'is_regular': 1, 'room_type': 'interior_door', 'width': 1.0}, {'area': 0.2, 'floor_polygon': [{'x': 2.4, 'y': 5.3}, {'x': 2.4, 'y': 6.9}, {'x': 2.5, 'y': 6.9}, {'x': 2.5, 'y': 5.3}], 'height': 1.5, 'id': 9, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.1}, {'area': 0.1, 'floor_polygon': [{'x': 8.8, 'y': 8.4}, {'x': 8.6, 'y': 8.4}, {'x': 8.6, 'y': 9.3}, {'x': 8.8, 'y': 9.3}], 'height': 0.8, 'id': 10, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.1}, {'area': 0.1, 'floor_polygon': [{'x': 12.1, 'y': 6.8}, {'x': 11.4, 'y': 6.8}, {'x': 11.4, 'y': 7.0}, {'x': 12.1, 'y': 7.0}], 'height': 0.1, 'id': 11, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.7}, {'area': 0.1, 'floor_polygon': [{'x': 11.0, 'y': 11.2}, {'x': 10.2, 'y': 11.2}, {'x': 10.2, 'y': 11.4}, {'x': 11.0, 'y': 11.4}], 'height': 0.1, 'id': 12, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.8}, {'area': 0.1, 'floor_polygon': [{'x': 12.4, 'y': 7.9}, {'x': 13.4, 'y': 7.9}, {'x': 13.4, 'y': 7.7}, {'x': 12.4, 'y': 7.7}], 'height': 0.1, 'id': 13, 'is_regular': 1, 'room_type': 'interior_door', 'width': 1.0}, {'area': 0.1, 'floor_polygon': [{'x': 9.9, 'y': 13.1}, {'x': 9.1, 'y': 13.1}, {'x': 9.1, 'y': 13.2}, {'x': 9.9, 'y': 13.2}], 'height': 0.1, 'id': 14, 'is_regular': 1, 'room_type': 'front_door', 'width': 0.8}]}}

                    5. {'input': {'room_count': 16, 'total_area': 74.0, 'room_types': ['bedroom', 'bathroom', 'bedroom', 'balcony', 'bathroom', 'kitchen', 'bedroom', 'living_room', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'front_door'], 'rooms': [{'room_type': 'bedroom', 'width': 3.0, 'height': 2.4, 'is_regular': 0}, {'room_type': 'bathroom', 'width': 2.7, 'height': 1.5, 'is_regular': 0}, {'room_type': 'bedroom', 'width': 2.3, 'height': 3.1, 'is_regular': 1}, {'room_type': 'balcony', 'width': 6.0, 'height': 1.8, 'is_regular': 0}, {'room_type': 'bathroom', 'width': 1.3, 'height': 2.4, 'is_regular': 1}, {'room_type': 'kitchen', 'width': 1.7, 'height': 2.3, 'is_regular': 1}, {'room_type': 'bedroom', 'width': 2.8, 'height': 4.2, 'is_regular': 0}, {'room_type': 'living_room', 'width': 7.0, 'height': 8.6, 'is_regular': 0}, {'room_type': 'interior_door', 'width': 0.1, 'height': 0.4, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 0.4, 'height': 0.1, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 0.8, 'height': 0.1, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 2.7, 'height': 0.1, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 0.6, 'height': 0.1, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 0.1, 'height': 1.5, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 0.5, 'height': 0.1, 'is_regular': 1}, {'room_type': 'front_door', 'width': 0.3, 'height': 0.8, 'is_regular': 1}]}}
                       {'output': {'room_count': 16, 'total_area': 74.0, 'room_types': ['bedroom', 'bathroom', 'bedroom', 'balcony', 'bathroom', 'kitchen', 'bedroom', 'living_room', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'front_door'], 'rooms': [{'area': 7.0, 'floor_polygon': [{'x': 13.2, 'y': 7.8}, {'x': 13.2, 'y': 5.5}, {'x': 11.7, 'y': 5.5}, {'x': 11.7, 'y': 5.4}, {'x': 10.3, 'y': 5.4}, {'x': 10.3, 'y': 7.8}], 'height': 2.4, 'id': 0, 'is_regular': 0, 'room_type': 'bedroom', 'width': 3.0}, {'area': 4.1, 'floor_polygon': [{'x': 13.1, 'y': 9.6}, {'x': 14.0, 'y': 9.6}, {'x': 14.0, 'y': 8.1}, {'x': 11.3, 'y': 8.1}, {'x': 11.3, 'y': 9.6}, {'x': 13.1, 'y': 9.6}], 'height': 1.5, 'id': 1, 'is_regular': 0, 'room_type': 'bathroom', 'width': 2.7}, {'area': 7.2, 'floor_polygon': [{'x': 7.6, 'y': 9.1}, {'x': 7.6, 'y': 12.2}, {'x': 9.9, 'y': 12.2}, {'x': 9.9, 'y': 9.1}], 'height': 3.1, 'id': 2, 'is_regular': 1, 'room_type': 'bedroom', 'width': 2.3}, {'area': 10.9, 'floor_polygon': [{'x': 4.0, 'y': 14.3}, {'x': 10.0, 'y': 14.3}, {'x': 10.0, 'y': 13.6}, {'x': 9.9, 'y': 13.6}, {'x': 9.9, 'y': 12.5}, {'x': 4.0, 'y': 12.5}], 'height': 1.8, 'id': 3, 'is_regular': 0, 'room_type': 'balcony', 'width': 6.0}, {'area': 3.2, 'floor_polygon': [{'x': 8.6, 'y': 5.4}, {'x': 8.6, 'y': 7.8}, {'x': 10.0, 'y': 7.8}, {'x': 10.0, 'y': 5.4}], 'height': 2.4, 'id': 4, 'is_regular': 1, 'room_type': 'bathroom', 'width': 1.3}, {'area': 3.9, 'floor_polygon': [{'x': 6.7, 'y': 7.8}, {'x': 8.4, 'y': 7.8}, {'x': 8.4, 'y': 5.5}, {'x': 6.7, 'y': 5.5}], 'height': 2.3, 'id': 5, 'is_regular': 1, 'room_type': 'kitchen', 'width': 1.7}, {'area': 10.2, 'floor_polygon': [{'x': 11.0, 'y': 9.1}, {'x': 10.3, 'y': 9.1}, {'x': 10.3, 'y': 13.4}, {'x': 13.1, 'y': 13.4}, {'x': 13.1, 'y': 9.9}, {'x': 11.0, 'y': 9.9}], 'height': 4.2, 'id': 6, 'is_regular': 0, 'room_type': 'bedroom', 'width': 2.8}, {'area': 26.2, 'floor_polygon': [{'x': 4.1, 'y': 10.1}, {'x': 4.1, 'y': 12.2}, {'x': 7.2, 'y': 12.2}, {'x': 7.2, 'y': 8.9}, {'x': 11.0, 'y': 8.9}, {'x': 11.0, 'y': 8.1}, {'x': 6.4, 'y': 8.1}, {'x': 6.4, 'y': 3.7}, {'x': 4.1, 'y': 3.7}, {'x': 4.1, 'y': 8.1}, {'x': 4.0, 'y': 8.1}, {'x': 4.0, 'y': 10.1}], 'height': 8.6, 'id': 7, 'is_regular': 0, 'room_type': 'living_room', 'width': 7.0}, {'area': 0.1, 'floor_polygon': [{'x': 11.1, 'y': 8.3}, {'x': 11.1, 'y': 8.7}, {'x': 11.2, 'y': 8.7}, {'x': 11.2, 'y': 8.3}], 'height': 0.4, 'id': 8, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.1}, {'area': 0.1, 'floor_polygon': [{'x': 10.9, 'y': 8.0}, {'x': 10.9, 'y': 7.9}, {'x': 10.5, 'y': 7.9}, {'x': 10.5, 'y': 8.0}], 'height': 0.1, 'id': 9, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.4}, {'area': 0.1, 'floor_polygon': [{'x': 8.4, 'y': 8.9}, {'x': 7.6, 'y': 8.9}, {'x': 7.6, 'y': 9.1}, {'x': 8.4, 'y': 9.1}], 'height': 0.1, 'id': 10, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.8}, {'area': 0.4, 'floor_polygon': [{'x': 4.2, 'y': 12.3}, {'x': 4.2, 'y': 12.4}, {'x': 6.9, 'y': 12.4}, {'x': 6.9, 'y': 12.3}], 'height': 0.1, 'id': 11, 'is_regular': 1, 'room_type': 'interior_door', 'width': 2.7}, {'area': 0.1, 'floor_polygon': [{'x': 9.5, 'y': 8.0}, {'x': 9.5, 'y': 7.9}, {'x': 8.9, 'y': 7.9}, {'x': 8.9, 'y': 8.0}], 'height': 0.1, 'id': 12, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.6}, {'area': 0.2, 'floor_polygon': [{'x': 6.6, 'y': 5.8}, {'x': 6.5, 'y': 5.8}, {'x': 6.5, 'y': 7.4}, {'x': 6.6, 'y': 7.4}], 'height': 1.5, 'id': 13, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.1}, {'area': 0.1, 'floor_polygon': [{'x': 10.4, 'y': 9.1}, {'x': 10.9, 'y': 9.1}, {'x': 10.9, 'y': 8.9}, {'x': 10.4, 'y': 8.9}], 'height': 0.1, 'id': 14, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.5}, {'area': 0.2, 'floor_polygon': [{'x': 3.7, 'y': 3.9}, {'x': 3.7, 'y': 4.8}, {'x': 4.0, 'y': 4.8}, {'x': 4.0, 'y': 3.9}], 'height': 0.8, 'id': 15, 'is_regular': 1, 'room_type': 'front_door', 'width': 0.3}]}}

                    6. {'input': {'room_count': 11, 'total_area': 58.9, 'room_types': ['living_room', 'kitchen', 'bedroom', 'bedroom', 'balcony', 'bathroom', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'front_door'], 'rooms': [{'room_type': 'living_room', 'width': 4.9, 'height': 9.4, 'is_regular': 0}, {'room_type': 'kitchen', 'width': 2.0, 'height': 2.0, 'is_regular': 1}, {'room_type': 'bedroom', 'width': 2.9, 'height': 2.9, 'is_regular': 1}, {'room_type': 'bedroom', 'width': 2.9, 'height': 4.5, 'is_regular': 0}, {'room_type': 'balcony', 'width': 3.4, 'height': 0.8, 'is_regular': 1}, {'room_type': 'bathroom', 'width': 1.6, 'height': 1.8, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 0.1, 'height': 1.0, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 1.0, 'height': 0.3, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 0.8, 'height': 0.1, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 0.1, 'height': 0.7, 'is_regular': 1}, {'room_type': 'front_door', 'width': 1.0, 'height': 0.3, 'is_regular': 1}]}}
                       {'output': {'room_count': 11, 'total_area': 58.9, 'room_types': ['living_room', 'kitchen', 'bedroom', 'bedroom', 'balcony', 'bathroom', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'front_door'], 'rooms': [{'area': 28.4, 'floor_polygon': [{'x': 9.1, 'y': 8.6}, {'x': 9.1, 'y': 6.0}, {'x': 6.8, 'y': 6.0}, {'x': 6.8, 'y': 3.7}, {'x': 5.6, 'y': 3.7}, {'x': 5.6, 'y': 13.1}, {'x': 9.1, 'y': 13.1}, {'x': 9.1, 'y': 9.6}, {'x': 10.5, 'y': 9.6}, {'x': 10.5, 'y': 8.6}], 'height': 9.4, 'id': 0, 'is_regular': 0, 'room_type': 'living_room', 'width': 4.9}, {'area': 4.2, 'floor_polygon': [{'x': 7.0, 'y': 3.7}, {'x': 7.0, 'y': 5.7}, {'x': 9.1, 'y': 5.7}, {'x': 9.1, 'y': 3.7}], 'height': 2.0, 'id': 1, 'is_regular': 1, 'room_type': 'kitchen', 'width': 2.0}, {'area': 8.3, 'floor_polygon': [{'x': 9.5, 'y': 8.2}, {'x': 12.4, 'y': 8.2}, {'x': 12.4, 'y': 5.3}, {'x': 9.5, 'y': 5.3}], 'height': 2.9, 'id': 2, 'is_regular': 1, 'room_type': 'bedroom', 'width': 2.9}, {'area': 11.4, 'floor_polygon': [{'x': 9.5, 'y': 9.8}, {'x': 9.5, 'y': 14.3}, {'x': 12.4, 'y': 14.3}, {'x': 12.4, 'y': 10.7}, {'x': 10.5, 'y': 10.7}, {'x': 10.5, 'y': 9.8}], 'height': 4.5, 'id': 3, 'is_regular': 0, 'room_type': 'bedroom', 'width': 2.9}, {'area': 2.9, 'floor_polygon': [{'x': 9.1, 'y': 14.3}, {'x': 9.1, 'y': 13.5}, {'x': 5.6, 'y': 13.5}, {'x': 5.6, 'y': 14.3}], 'height': 0.8, 'id': 4, 'is_regular': 1, 'room_type': 'balcony', 'width': 3.4}, {'area': 2.8, 'floor_polygon': [{'x': 10.8, 'y': 10.4}, {'x': 12.4, 'y': 10.4}, {'x': 12.4, 'y': 8.6}, {'x': 10.8, 'y': 8.6}], 'height': 1.8, 'id': 5, 'is_regular': 1, 'room_type': 'bathroom', 'width': 1.6}, {'area': 0.1, 'floor_polygon': [{'x': 7.0, 'y': 5.0}, {'x': 7.0, 'y': 4.0}, {'x': 6.8, 'y': 4.0}, {'x': 6.8, 'y': 5.0}], 'height': 1.0, 'id': 6, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.1}, {'area': 0.3, 'floor_polygon': [{'x': 9.4, 'y': 8.6}, {'x': 10.3, 'y': 8.6}, {'x': 10.3, 'y': 8.3}, {'x': 9.4, 'y': 8.3}], 'height': 0.3, 'id': 7, 'is_regular': 1, 'room_type': 'interior_door', 'width': 1.0}, {'area': 0.1, 'floor_polygon': [{'x': 9.5, 'y': 9.6}, {'x': 9.5, 'y': 9.8}, {'x': 10.3, 'y': 9.8}, {'x': 10.3, 'y': 9.6}], 'height': 0.1, 'id': 8, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.8}, {'area': 0.1, 'floor_polygon': [{'x': 10.5, 'y': 8.7}, {'x': 10.5, 'y': 9.4}, {'x': 10.7, 'y': 9.4}, {'x': 10.7, 'y': 8.7}], 'height': 0.7, 'id': 9, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.1}, {'area': 0.3, 'floor_polygon': [{'x': 6.8, 'y': 3.3}, {'x': 5.8, 'y': 3.3}, {'x': 5.8, 'y': 3.6}, {'x': 6.8, 'y': 3.6}], 'height': 0.3, 'id': 10, 'is_regular': 1, 'room_type': 'front_door', 'width': 1.0}]}}

                    7. {'input': {'room_count': 12, 'total_area': 60.6, 'room_types': ['balcony', 'bedroom', 'bedroom', 'kitchen', 'living_room', 'bathroom', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'front_door'], 'rooms': [{'room_type': 'balcony', 'width': 3.5, 'height': 1.1, 'is_regular': 1}, {'room_type': 'bedroom', 'width': 4.4, 'height': 2.9, 'is_regular': 1}, {'room_type': 'bedroom', 'width': 2.9, 'height': 3.6, 'is_regular': 1}, {'room_type': 'kitchen', 'width': 2.9, 'height': 1.5, 'is_regular': 1}, {'room_type': 'living_room', 'width': 3.5, 'height': 8.8, 'is_regular': 0}, {'room_type': 'bathroom', 'width': 1.6, 'height': 2.3, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 0.3, 'height': 0.6, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 2.1, 'height': 0.3, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 0.3, 'height': 0.6, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 0.3, 'height': 0.6, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 0.3, 'height': 0.8, 'is_regular': 1}, {'room_type': 'front_door', 'width': 0.8, 'height': 0.3, 'is_regular': 1}]}}
                       {'output': {'room_count': 12, 'total_area': 60.6, 'room_types': ['balcony', 'bedroom', 'bedroom', 'kitchen', 'living_room', 'bathroom', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'front_door'], 'rooms': [{'area': 3.7, 'floor_polygon': [{'x': 13.1, 'y': 13.1}, {'x': 9.6, 'y': 13.1}, {'x': 9.6, 'y': 14.1}, {'x': 13.1, 'y': 14.1}], 'height': 1.1, 'id': 0, 'is_regular': 1, 'room_type': 'balcony', 'width': 3.5}, {'area': 12.6, 'floor_polygon': [{'x': 9.2, 'y': 3.9}, {'x': 4.9, 'y': 3.9}, {'x': 4.9, 'y': 6.8}, {'x': 9.2, 'y': 6.8}], 'height': 2.9, 'id': 1, 'is_regular': 1, 'room_type': 'bedroom', 'width': 4.4}, {'area': 10.3, 'floor_polygon': [{'x': 9.2, 'y': 12.7}, {'x': 9.2, 'y': 9.1}, {'x': 6.3, 'y': 9.1}, {'x': 6.3, 'y': 12.7}], 'height': 3.6, 'id': 2, 'is_regular': 1, 'room_type': 'bedroom', 'width': 2.9}, {'area': 4.3, 'floor_polygon': [{'x': 9.2, 'y': 7.2}, {'x': 6.3, 'y': 7.2}, {'x': 6.3, 'y': 8.6}, {'x': 9.2, 'y': 8.6}], 'height': 1.5, 'id': 3, 'is_regular': 1, 'room_type': 'kitchen', 'width': 2.9}, {'area': 24.3, 'floor_polygon': [{'x': 9.6, 'y': 3.9}, {'x': 9.6, 'y': 12.7}, {'x': 13.1, 'y': 12.7}, {'x': 13.1, 'y': 7.1}, {'x': 11.1, 'y': 7.1}, {'x': 11.1, 'y': 3.9}], 'height': 8.8, 'id': 4, 'is_regular': 0, 'room_type': 'living_room', 'width': 3.5}, {'area': 3.8, 'floor_polygon': [{'x': 11.5, 'y': 4.5}, {'x': 11.5, 'y': 6.8}, {'x': 13.1, 'y': 6.8}, {'x': 13.1, 'y': 4.5}], 'height': 2.3, 'id': 5, 'is_regular': 1, 'room_type': 'bathroom', 'width': 1.6}, {'area': 0.2, 'floor_polygon': [{'x': 9.3, 'y': 6.6}, {'x': 9.6, 'y': 6.6}, {'x': 9.6, 'y': 6.0}, {'x': 9.3, 'y': 6.0}], 'height': 0.6, 'id': 6, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.3}, {'area': 0.6, 'floor_polygon': [{'x': 10.4, 'y': 12.7}, {'x': 10.4, 'y': 13.0}, {'x': 12.5, 'y': 13.0}, {'x': 12.5, 'y': 12.7}], 'height': 0.3, 'id': 7, 'is_regular': 1, 'room_type': 'interior_door', 'width': 2.1}, {'area': 0.2, 'floor_polygon': [{'x': 9.6, 'y': 9.8}, {'x': 9.6, 'y': 9.3}, {'x': 9.3, 'y': 9.3}, {'x': 9.3, 'y': 9.8}], 'height': 0.6, 'id': 8, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.3}, {'area': 0.2, 'floor_polygon': [{'x': 9.3, 'y': 7.4}, {'x': 9.3, 'y': 8.0}, {'x': 9.6, 'y': 8.0}, {'x': 9.6, 'y': 7.4}], 'height': 0.6, 'id': 9, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.3}, {'area': 0.2, 'floor_polygon': [{'x': 11.2, 'y': 5.6}, {'x': 11.2, 'y': 6.4}, {'x': 11.5, 'y': 6.4}, {'x': 11.5, 'y': 5.6}], 'height': 0.8, 'id': 10, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.3}, {'area': 0.2, 'floor_polygon': [{'x': 10.2, 'y': 3.8}, {'x': 11.0, 'y': 3.8}, {'x': 11.0, 'y': 3.5}, {'x': 10.2, 'y': 3.5}], 'height': 0.3, 'id': 11, 'is_regular': 1, 'room_type': 'front_door', 'width': 0.8}]}}

                    8. {'input': {'room_count': 14, 'total_area': 77.8, 'room_types': ['bedroom', 'bedroom', 'balcony', 'living_room', 'bedroom', 'kitchen', 'bathroom', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'front_door'], 'rooms': [{'room_type': 'bedroom', 'width': 3.5, 'height': 4.2, 'is_regular': 1}, {'room_type': 'bedroom', 'width': 3.3, 'height': 4.2, 'is_regular': 1}, {'room_type': 'balcony', 'width': 3.3, 'height': 1.1, 'is_regular': 1}, {'room_type': 'living_room', 'width': 7.1, 'height': 4.9, 'is_regular': 0}, {'room_type': 'bedroom', 'width': 3.3, 'height': 3.4, 'is_regular': 1}, {'room_type': 'kitchen', 'width': 2.0, 'height': 3.4, 'is_regular': 1}, {'room_type': 'bathroom', 'width': 1.5, 'height': 2.2, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 0.4, 'height': 0.1, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 0.4, 'height': 0.1, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 0.4, 'height': 0.1, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 0.4, 'height': 0.1, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 0.1, 'height': 0.7, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 0.4, 'height': 0.1, 'is_regular': 1}, {'room_type': 'front_door', 'width': 0.1, 'height': 0.7, 'is_regular': 1}]}}
                       {'output': {'room_count': 14, 'total_area': 77.8, 'room_types': ['bedroom', 'bedroom', 'balcony', 'living_room', 'bedroom', 'kitchen', 'bathroom', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'front_door'], 'rooms': [{'area': 14.8, 'floor_polygon': [{'x': 8.2, 'y': 14.2}, {'x': 11.7, 'y': 14.2}, {'x': 11.7, 'y': 10.0}, {'x': 8.2, 'y': 10.0}], 'height': 4.2, 'id': 0, 'is_regular': 1, 'room_type': 'bedroom', 'width': 3.5}, {'area': 13.9, 'floor_polygon': [{'x': 4.6, 'y': 14.2}, {'x': 7.9, 'y': 14.2}, {'x': 7.9, 'y': 10.0}, {'x': 4.6, 'y': 10.0}], 'height': 4.2, 'id': 1, 'is_regular': 1, 'room_type': 'bedroom', 'width': 3.3}, {'area': 3.7, 'floor_polygon': [{'x': 4.6, 'y': 14.5}, {'x': 4.6, 'y': 15.6}, {'x': 7.9, 'y': 15.6}, {'x': 7.9, 'y': 14.5}], 'height': 1.1, 'id': 2, 'is_regular': 1, 'room_type': 'balcony', 'width': 3.3}, {'area': 23.7, 'floor_polygon': [{'x': 4.6, 'y': 8.9}, {'x': 4.6, 'y': 9.7}, {'x': 11.7, 'y': 9.7}, {'x': 11.7, 'y': 6.0}, {'x': 7.6, 'y': 6.0}, {'x': 7.6, 'y': 4.9}, {'x': 6.0, 'y': 4.9}, {'x': 6.0, 'y': 8.9}], 'height': 4.9, 'id': 3, 'is_regular': 0, 'room_type': 'living_room', 'width': 7.1}, {'area': 11.2, 'floor_polygon': [{'x': 10.1, 'y': 2.4}, {'x': 10.1, 'y': 5.8}, {'x': 13.4, 'y': 5.8}, {'x': 13.4, 'y': 2.4}], 'height': 3.4, 'id': 4, 'is_regular': 1, 'room_type': 'bedroom', 'width': 3.3}, {'area': 6.6, 'floor_polygon': [{'x': 9.8, 'y': 5.8}, {'x': 9.8, 'y': 2.4}, {'x': 7.9, 'y': 2.4}, {'x': 7.9, 'y': 5.8}], 'height': 3.4, 'id': 5, 'is_regular': 1, 'room_type': 'kitchen', 'width': 2.0}, {'area': 3.4, 'floor_polygon': [{'x': 7.6, 'y': 2.4}, {'x': 6.0, 'y': 2.4}, {'x': 6.0, 'y': 4.6}, {'x': 7.6, 'y': 4.6}], 'height': 2.2, 'id': 6, 'is_regular': 1, 'room_type': 'bathroom', 'width': 1.5}, {'area': 0.1, 'floor_polygon': [{'x': 7.3, 'y': 14.3}, {'x': 7.3, 'y': 14.4}, {'x': 7.7, 'y': 14.4}, {'x': 7.7, 'y': 14.3}], 'height': 0.1, 'id': 7, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.4}, {'area': 0.1, 'floor_polygon': [{'x': 7.3, 'y': 9.8}, {'x': 7.3, 'y': 9.9}, {'x': 7.7, 'y': 9.9}, {'x': 7.7, 'y': 9.8}], 'height': 0.1, 'id': 8, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.4}, {'area': 0.0, 'floor_polygon': [{'x': 8.4, 'y': 9.9}, {'x': 8.7, 'y': 9.9}, {'x': 8.7, 'y': 9.8}, {'x': 8.4, 'y': 9.8}], 'height': 0.1, 'id': 9, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.4}, {'area': 0.0, 'floor_polygon': [{'x': 10.3, 'y': 6.0}, {'x': 10.7, 'y': 6.0}, {'x': 10.7, 'y': 5.8}, {'x': 10.3, 'y': 5.8}], 'height': 0.1, 'id': 10, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.4}, {'area': 0.1, 'floor_polygon': [{'x': 7.8, 'y': 5.9}, {'x': 7.8, 'y': 5.2}, {'x': 7.7, 'y': 5.2}, {'x': 7.7, 'y': 5.9}], 'height': 0.7, 'id': 11, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.1}, {'area': 0.1, 'floor_polygon': [{'x': 7.5, 'y': 4.8}, {'x': 7.5, 'y': 4.6}, {'x': 7.0, 'y': 4.6}, {'x': 7.0, 'y': 4.8}], 'height': 0.1, 'id': 12, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.4}, {'area': 0.1, 'floor_polygon': [{'x': 6.0, 'y': 8.7}, {'x': 6.0, 'y': 8.0}, {'x': 5.8, 'y': 8.0}, {'x': 5.8, 'y': 8.7}], 'height': 0.7, 'id': 13, 'is_regular': 1, 'room_type': 'front_door', 'width': 0.1}]}}

                    9. {'input': {'room_count': 14, 'total_area': 95.0, 'room_types': ['bathroom', 'bedroom', 'bedroom', 'study_room', 'bathroom', 'kitchen', 'living_room', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'front_door'], 'rooms': [{'room_type': 'bathroom', 'width': 2.0, 'height': 1.9, 'is_regular': 1}, {'room_type': 'bedroom', 'width': 3.8, 'height': 3.2, 'is_regular': 1}, {'room_type': 'bedroom', 'width': 2.9, 'height': 3.2, 'is_regular': 1}, {'room_type': 'study_room', 'width': 4.0, 'height': 2.3, 'is_regular': 1}, {'room_type': 'bathroom', 'width': 3.4, 'height': 2.0, 'is_regular': 1}, {'room_type': 'kitchen', 'width': 1.4, 'height': 3.2, 'is_regular': 1}, {'room_type': 'living_room', 'width': 11.1, 'height': 6.9, 'is_regular': 0}, {'room_type': 'interior_door', 'width': 0.3, 'height': 1.7, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 0.3, 'height': 0.8, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 0.3, 'height': 0.8, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 0.3, 'height': 1.0, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 0.3, 'height': 1.0, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 0.3, 'height': 3.0, 'is_regular': 1}, {'room_type': 'front_door', 'width': 1.1, 'height': 0.3, 'is_regular': 1}]}}
                       {'output': {'room_count': 14, 'total_area': 95.0, 'room_types': ['bathroom', 'bedroom', 'bedroom', 'study_room', 'bathroom', 'kitchen', 'living_room', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'front_door'], 'rooms': [{'area': 3.7, 'floor_polygon': [{'x': 10.3, 'y': 3.7}, {'x': 8.4, 'y': 3.7}, {'x': 8.4, 'y': 5.6}, {'x': 10.3, 'y': 5.6}], 'height': 1.9, 'id': 0, 'is_regular': 1, 'room_type': 'bathroom', 'width': 2.0}, {'area': 12.3, 'floor_polygon': [{'x': 4.1, 'y': 3.7}, {'x': 4.1, 'y': 7.0}, {'x': 7.9, 'y': 7.0}, {'x': 7.9, 'y': 3.7}], 'height': 3.2, 'id': 1, 'is_regular': 1, 'room_type': 'bedroom', 'width': 3.8}, {'area': 9.3, 'floor_polygon': [{'x': 13.6, 'y': 7.0}, {'x': 13.6, 'y': 3.7}, {'x': 10.8, 'y': 3.7}, {'x': 10.8, 'y': 7.0}], 'height': 3.2, 'id': 2, 'is_regular': 1, 'room_type': 'bedroom', 'width': 2.9}, {'area': 9.3, 'floor_polygon': [{'x': 4.1, 'y': 12.0}, {'x': 4.1, 'y': 14.3}, {'x': 8.2, 'y': 14.3}, {'x': 8.2, 'y': 12.0}], 'height': 2.3, 'id': 3, 'is_regular': 1, 'room_type': 'study_room', 'width': 4.0}, {'area': 6.8, 'floor_polygon': [{'x': 13.6, 'y': 12.9}, {'x': 13.6, 'y': 11.0}, {'x': 10.2, 'y': 11.0}, {'x': 10.2, 'y': 12.9}], 'height': 2.0, 'id': 4, 'is_regular': 1, 'room_type': 'bathroom', 'width': 3.4}, {'area': 4.4, 'floor_polygon': [{'x': 15.5, 'y': 7.4}, {'x': 14.1, 'y': 7.4}, {'x': 14.1, 'y': 10.5}, {'x': 15.5, 'y': 10.5}], 'height': 3.2, 'id': 5, 'is_regular': 1, 'room_type': 'kitchen', 'width': 1.4}, {'area': 46.6, 'floor_polygon': [{'x': 10.3, 'y': 7.4}, {'x': 10.3, 'y': 6.0}, {'x': 8.4, 'y': 6.0}, {'x': 8.4, 'y': 7.4}, {'x': 2.5, 'y': 7.4}, {'x': 2.5, 'y': 11.5}, {'x': 8.6, 'y': 11.5}, {'x': 8.6, 'y': 12.9}, {'x': 9.8, 'y': 12.9}, {'x': 9.8, 'y': 11.0}, {'x': 9.7, 'y': 11.0}, {'x': 9.7, 'y': 10.5}, {'x': 13.6, 'y': 10.5}, {'x': 13.6, 'y': 7.4}], 'height': 6.9, 'id': 6, 'is_regular': 0, 'room_type': 'living_room', 'width': 11.1}, {'area': 0.5, 'floor_polygon': [{'x': 8.3, 'y': 5.6}, {'x': 8.3, 'y': 3.9}, {'x': 8.0, 'y': 3.9}, {'x': 8.0, 'y': 5.6}], 'height': 1.7, 'id': 7, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.3}, {'area': 0.2, 'floor_polygon': [{'x': 8.0, 'y': 7.0}, {'x': 8.3, 'y': 7.0}, {'x': 8.3, 'y': 6.2}, {'x': 8.0, 'y': 6.2}], 'height': 0.8, 'id': 8, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.3}, {'area': 0.2, 'floor_polygon': [{'x': 10.7, 'y': 6.2}, {'x': 10.4, 'y': 6.2}, {'x': 10.4, 'y': 7.0}, {'x': 10.7, 'y': 7.0}], 'height': 0.8, 'id': 9, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.3}, {'area': 0.3, 'floor_polygon': [{'x': 8.5, 'y': 11.9}, {'x': 8.2, 'y': 11.9}, {'x': 8.2, 'y': 12.9}, {'x': 8.5, 'y': 12.9}], 'height': 1.0, 'id': 10, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.3}, {'area': 0.3, 'floor_polygon': [{'x': 9.8, 'y': 11.9}, {'x': 10.1, 'y': 11.9}, {'x': 10.1, 'y': 10.9}, {'x': 9.8, 'y': 10.9}], 'height': 1.0, 'id': 11, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.3}, {'area': 0.8, 'floor_polygon': [{'x': 13.7, 'y': 7.5}, {'x': 13.7, 'y': 10.5}, {'x': 14.0, 'y': 10.5}, {'x': 14.0, 'y': 7.5}], 'height': 3.0, 'id': 12, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.3}, {'area': 0.3, 'floor_polygon': [{'x': 8.5, 'y': 13.3}, {'x': 9.6, 'y': 13.3}, {'x': 9.6, 'y': 13.0}, {'x': 8.5, 'y': 13.0}], 'height': 0.3, 'id': 13, 'is_regular': 1, 'room_type': 'front_door', 'width': 1.1}]}}

                    10. {'input': {'room_count': 14, 'total_area': 66.3, 'room_types': ['balcony', 'bedroom', 'kitchen', 'bathroom', 'living_room', 'bedroom', 'balcony', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'front_door'], 'rooms': [{'room_type': 'balcony', 'width': 1.8, 'height': 1.1, 'is_regular': 1}, {'room_type': 'bedroom', 'width': 3.3, 'height': 3.4, 'is_regular': 1}, {'room_type': 'kitchen', 'width': 1.8, 'height': 2.4, 'is_regular': 1}, {'room_type': 'bathroom', 'width': 2.6, 'height': 1.7, 'is_regular': 1}, {'room_type': 'living_room', 'width': 6.8, 'height': 4.7, 'is_regular': 0}, {'room_type': 'bedroom', 'width': 3.6, 'height': 4.4, 'is_regular': 1}, {'room_type': 'balcony', 'width': 3.6, 'height': 1.1, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 1.3, 'height': 0.1, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 0.1, 'height': 0.6, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 0.9, 'height': 0.1, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 0.8, 'height': 0.1, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 0.8, 'height': 0.1, 'is_regular': 1}, {'room_type': 'interior_door', 'width': 2.4, 'height': 0.1, 'is_regular': 1}, {'room_type': 'front_door', 'width': 0.1, 'height': 0.8, 'is_regular': 1}]}}
                        {'output': {'room_count': 14, 'total_area': 66.3, 'room_types': ['balcony', 'bedroom', 'kitchen', 'bathroom', 'living_room', 'bedroom', 'balcony', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'interior_door', 'front_door'], 'rooms': [{'area': 1.9, 'floor_polygon': [{'x': 8.4, 'y': 1.6}, {'x': 8.4, 'y': 2.7}, {'x': 10.3, 'y': 2.7}, {'x': 10.3, 'y': 1.6}], 'height': 1.1, 'id': 0, 'is_regular': 1, 'room_type': 'balcony', 'width': 1.8}, {'area': 11.4, 'floor_polygon': [{'x': 8.2, 'y': 6.4}, {'x': 8.2, 'y': 3.0}, {'x': 4.9, 'y': 3.0}, {'x': 4.9, 'y': 6.4}], 'height': 3.4, 'id': 1, 'is_regular': 1, 'room_type': 'bedroom', 'width': 3.3}, {'area': 4.4, 'floor_polygon': [{'x': 10.3, 'y': 5.3}, {'x': 10.3, 'y': 3.0}, {'x': 8.4, 'y': 3.0}, {'x': 8.4, 'y': 5.3}], 'height': 2.4, 'id': 2, 'is_regular': 1, 'room_type': 'kitchen', 'width': 1.8}, {'area': 4.4, 'floor_polygon': [{'x': 13.1, 'y': 10.6}, {'x': 10.5, 'y': 10.6}, {'x': 10.5, 'y': 12.3}, {'x': 13.1, 'y': 12.3}], 'height': 1.7, 'id': 3, 'is_regular': 1, 'room_type': 'bathroom', 'width': 2.6}, {'area': 23.6, 'floor_polygon': [{'x': 11.7, 'y': 9.0}, {'x': 10.3, 'y': 9.0}, {'x': 10.3, 'y': 5.6}, {'x': 8.4, 'y': 5.6}, {'x': 8.4, 'y': 6.7}, {'x': 4.9, 'y': 6.7}, {'x': 4.9, 'y': 10.3}, {'x': 11.7, 'y': 10.3}], 'height': 4.7, 'id': 4, 'is_regular': 0, 'room_type': 'living_room', 'width': 6.8}, {'area': 15.6, 'floor_polygon': [{'x': 10.3, 'y': 10.6}, {'x': 6.7, 'y': 10.6}, {'x': 6.7, 'y': 15.0}, {'x': 10.3, 'y': 15.0}], 'height': 4.4, 'id': 5, 'is_regular': 1, 'room_type': 'bedroom', 'width': 3.6}, {'area': 4.0, 'floor_polygon': [{'x': 6.7, 'y': 15.3}, {'x': 6.7, 'y': 16.4}, {'x': 10.3, 'y': 16.4}, {'x': 10.3, 'y': 15.3}], 'height': 1.1, 'id': 6, 'is_regular': 1, 'room_type': 'balcony', 'width': 3.6}, {'area': 0.2, 'floor_polygon': [{'x': 8.6, 'y': 2.9}, {'x': 10.0, 'y': 2.9}, {'x': 10.0, 'y': 2.7}, {'x': 8.6, 'y': 2.7}], 'height': 0.1, 'id': 7, 'is_regular': 1, 'room_type': 'interior_door', 'width': 1.3}, {'area': 0.1, 'floor_polygon': [{'x': 8.2, 'y': 6.5}, {'x': 8.4, 'y': 6.5}, {'x': 8.4, 'y': 5.8}, {'x': 8.2, 'y': 5.8}], 'height': 0.6, 'id': 8, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.1}, {'area': 0.1, 'floor_polygon': [{'x': 9.6, 'y': 5.6}, {'x': 9.6, 'y': 5.4}, {'x': 8.6, 'y': 5.4}, {'x': 8.6, 'y': 5.6}], 'height': 0.1, 'id': 9, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.9}, {'area': 0.1, 'floor_polygon': [{'x': 10.8, 'y': 10.4}, {'x': 10.8, 'y': 10.5}, {'x': 11.5, 'y': 10.5}, {'x': 11.5, 'y': 10.4}], 'height': 0.1, 'id': 10, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.8}, {'area': 0.1, 'floor_polygon': [{'x': 10.1, 'y': 10.5}, {'x': 10.1, 'y': 10.4}, {'x': 9.3, 'y': 10.4}, {'x': 9.3, 'y': 10.5}], 'height': 0.1, 'id': 11, 'is_regular': 1, 'room_type': 'interior_door', 'width': 0.8}, {'area': 0.3, 'floor_polygon': [{'x': 7.2, 'y': 15.0}, {'x': 7.2, 'y': 15.2}, {'x': 9.6, 'y': 15.2}, {'x': 9.6, 'y': 15.0}], 'height': 0.1, 'id': 12, 'is_regular': 1, 'room_type': 'interior_door', 'width': 2.4}, {'area': 0.1, 'floor_polygon': [{'x': 11.9, 'y': 9.9}, {'x': 11.9, 'y': 9.1}, {'x': 11.7, 'y': 9.1}, {'x': 11.7, 'y': 9.9}], 'height': 0.8, 'id': 13, 'is_regular': 1, 'room_type': 'front_door', 'width': 0.1}]}}
                """
            }
        ]
        if history:
            history_text = "Below are details of your past attempts:\n"
            for i, attempt in enumerate(history):
                history_text += f"- Attempt {i + 1}:\n"
                history_text += f"    Output: {json.dumps(attempt['output'])}\n"
                history_text += f"    Feedback: {attempt.get('feedback', '[No feedback provided]')}\n"
            history_text += (
                f"This will be attempt number {len(history) + 1} to generate a valid floor plan. "
                "Please take all the above into account and try again.\n"
            )
            messages.append({"role": "user", "content": history_text})
        messages.append({"role": "user", "content": create_input(sample, is_str=True)})
        return messages

    def generate_floorplans_with_feedback(self, feedback_iterations=3):
        for i in tqdm(range(0, self.total_examples, self.batch_size), desc="Generating floorplans with feedback"):
            raw_batch = self.dataset[i: i + self.batch_size]
            samples = [dict(zip(raw_batch.keys(), t)) for t in zip(*raw_batch.values())]
            current_prompts = [self._build_prompt(sample) for sample in samples]
            resolved = [False] * len(samples)
            histories = [[] for _ in range(len(samples))]

            for iteration in range(feedback_iterations):
                unresolved_indices = [idx for idx, done in enumerate(resolved) if not done]
                if not unresolved_indices:
                    break

                batch_prompts = [current_prompts[idx] for idx in unresolved_indices]
                if self.model_name_or_path == "gpt-4o":
                    responses = []
                    for prompt in batch_prompts:
                        response = self.client.chat.completions.create(
                            model=self.model_name_or_path,
                            messages=prompt,
                            response_format={"type": "json_object"},
                            max_tokens=self.max_new_tokens,
                        )
                    responses.append(response)
                else:  
                    outputs = self.model.generate(
                        batch_prompts,
                        self.sampling_params,
                        lora_request=self.lora_request
                    )

                for pos, idx in enumerate(unresolved_indices):
                    if self.model_name_or_path == "gpt-4o":
                        generated_text = response.choices[pos].message.content
                    else:
                        generated_text = outputs[pos].outputs[0].text
                    output_json = extract_output_json(generated_text)
                    # print(generated_text)

                    sample_dir = os.path.join(self.output_dir, str(i + idx + self.test_range_start))
                    sample_dir_feedback = os.path.join(sample_dir, "feedback")
                    os.makedirs(sample_dir, exist_ok=True)
                    os.makedirs(sample_dir_feedback, exist_ok=True)

                    input_prompt = create_input(samples[idx], is_str=False)
                    with open(os.path.join(sample_dir, "prompt.json"), "w", encoding="utf-8") as f:
                        json.dump(input_prompt, f, indent=4)
                    with open(os.path.join(sample_dir, f"0.json"), "w", encoding="utf-8") as f:
                        json.dump(output_json, f, indent=4)
                    with open(os.path.join(sample_dir_feedback, f"iteration_{iteration}.json"), "w", encoding="utf-8") as f:
                        json.dump(output_json, f, indent=4)

                    overlap_metrics = FeedbackGenerator.analyze(output_json, input_prompt)

                    current_feedback = ""
                    if (overlap_metrics["is_overlapping"] or 
                        not overlap_metrics["is_valid_json"] or 
                        not overlap_metrics["room_count"]["match"] or 
                        # not overlap_metrics["room_types"]["match"] or 
                        not overlap_metrics["total_area"]["match"]):
                        current_feedback += FeedbackGenerator.create_feedback(overlap_metrics)
                    else:
                        resolved[idx] = True
                        current_feedback = "No issues detected."

                    attempt = {
                        "output": output_json,
                        "iteration": iteration,
                        "feedback": current_feedback,
                        "metrics": overlap_metrics
                    }
                    histories[idx].append(attempt)

                    if not resolved[idx]:
                        new_prompt = self._build_re_prompt(
                            samples[idx],
                            history=histories[idx]
                        )
                        current_prompts[idx] = new_prompt
                        print(new_prompt)

                    with open(os.path.join(sample_dir_feedback, "feedback.json"), "w", encoding="utf-8") as f:
                        filtered_history = [
                            {key: value for key, value in entry.items() if key != "output"}
                            for entry in histories[idx]
                        ]
                        json.dump(filtered_history, f, indent=4)

                    with open(os.path.join(sample_dir_feedback, "feedback.txt"), "a", encoding="utf-8") as f:
                        f.writelines(str(new_prompt))
                        f.write("\n")
                        f.writelines("=" * 20)
                        f.write("\n")

